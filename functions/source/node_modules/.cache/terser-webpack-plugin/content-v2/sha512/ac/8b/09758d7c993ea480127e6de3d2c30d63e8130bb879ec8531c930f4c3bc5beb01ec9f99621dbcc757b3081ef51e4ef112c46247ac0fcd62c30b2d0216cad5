{"map":"{\"version\":3,\"sources\":[\"transcribe/transcribeHandler.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"require\",\"__webpack_exports__\",\"extractBucketParams\",\"doesVocabularyExist\",\"getAudioMetadata\",\"createOrUpdateVocabulary\",\"handler\",\"aws_sdk__WEBPACK_IMPORTED_MODULE_1__\",\"_music_metadata_s3__WEBPACK_IMPORTED_MODULE_2__\",\"file_type__WEBPACK_IMPORTED_MODULE_3__\",\"file_type__WEBPACK_IMPORTED_MODULE_3___default\",\"transcribeService\",\"apiVersion\",\"documentClient\",\"DocumentClient\",\"s3\",\"event\",\"Records\",\"map\",\"bucket\",\"type\",\"includes\",\"size\",\"async\",\"getVocabulary\",\"VocabularyName\",\"process\",\"env\",\"CUSTOM_VOCABULARY_NAME\",\"promise\",\"message\",\"s3Object\",\"params\",\"Bucket\",\"Key\",\"decodeURIComponent\",\"stream\",\"getObject\",\"createReadStream\",\"mimeType\",\"fromStream\",\"meta\",\"headObject\",\"metadata\",\"disableChunked\",\"console\",\"log\",\"format\",\"destroy\",\"ext\",\"numberOfChannels\",\"Metadata\",\"vocab\",\"LanguageCode\",\"VocabularyFileUri\",\"updateVocabulary\",\"createVocabulary\",\"objectParams\",\"find\",\"s3Objects\",\"Promise\",\"all\",\"filter\",\"paramMap\",\"transcriptionJob\",\"Media\",\"MediaFileUri\",\"TranscriptionJobName\",\"MediaFormat\",\"OutputBucketName\",\"TRANSCRIBE_OUTPUT_BUCKET\",\"Settings\",\"ChannelIdentification\",\"ShowSpeakerLabels\",\"MaxSpeakerLabels\",\"customVocabulary\",\"startTranscriptionJob\",\"tableUpdates\",\"update\",\"TableName\",\"TABLE_NAME\",\"jobId\",\"jobid\",\"lastModified\",\"lastmodified\",\"ExpressionAttributeNames\",\"#status\",\"#transcriptionJobName\",\"ExpressionAttributeValues\",\":st1\",\":tjn\",\"UpdateExpression\",\"ReturnValues\",\"updated\",\"statusCode\",\"jobStatus\",\"res\",\"Attributes\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var a in t)e[a]=t[a]}(exports,function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,\"a\",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p=\"\",a(a.s=8)}([function(e,t){e.exports=require(\"aws-sdk\")},function(e,t){e.exports=require(\"source-map-support/register\")},,function(e,t){e.exports=require(\"@music-metadata/s3\")},function(e,t){e.exports=require(\"file-type\")},,,,function(e,t,a){\"use strict\";a.r(t),a.d(t,\"extractBucketParams\",(function(){return l})),a.d(t,\"doesVocabularyExist\",(function(){return d})),a.d(t,\"getAudioMetadata\",(function(){return p})),a.d(t,\"createOrUpdateVocabulary\",(function(){return m})),a.d(t,\"handler\",(function(){return b}));a(1);var n=a(0),r=a(3),o=a(4),i=a.n(o);const s=new n.TranscribeService({apiVersion:\"2017-10-26\"}),u=new n.DynamoDB.DocumentClient,c=new n.S3({apiVersion:\"2006-03-01\"}),l=e=>e.Records.map(({s3:e})=>({name:e.bucket.name,key:e.object.key,type:e.object.key.includes(\"txt\")?\"text\":\"audio\",size:e.object.size})),d=async()=>{try{return await s.getVocabulary({VocabularyName:process.env.CUSTOM_VOCABULARY_NAME}).promise(),!0}catch(e){if(\"The requested vocabulary couldn't be found. Check the vocabulary name and try your request again.\"===e.message)return!1;throw e}},p=async e=>{const t={Bucket:e.name,Key:decodeURIComponent(e.key)},a=c.getObject(t).createReadStream(),n=await i.a.fromStream(a),o=await c.headObject(t).promise(),s=await Object(r.parseS3Object)(c,t,{disableChunked:!0});return console.log(s.format),a.destroy(),{...e,format:n.ext,numberOfChannels:s.format.numberOfChannels,meta:o.Metadata}},m=async e=>{const t={LanguageCode:\"en-US\",VocabularyName:process.env.CUSTOM_VOCABULARY_NAME,VocabularyFileUri:`s3://${e.name}/${e.key}`};await d()?(console.log(\"Updating Vocabulary\"),await s.updateVocabulary(t).promise()):(await s.createVocabulary(t).promise(),console.log(\"Creating Vocabulary\"))},b=async e=>{const t=l(e);console.log(t);const a=t.find(e=>\"text\"===e.type);a&&await m(a);const n=await Promise.all(t.filter(e=>\"audio\"===e.type).map(e=>p(e))),r=n.filter(e=>\"audio\"===e.type).map(e=>{let t={LanguageCode:\"en-US\",Media:{MediaFileUri:decodeURIComponent(`s3://${e.name}/${e.key}`)},TranscriptionJobName:decodeURIComponent(e.key),MediaFormat:e.format,OutputBucketName:process.env.TRANSCRIBE_OUTPUT_BUCKET};t=e.numberOfChannels>1?{...t,Settings:{ChannelIdentification:!0,ShowSpeakerLabels:!1}}:{...t,Settings:{ChannelIdentification:!1,ShowSpeakerLabels:!0,MaxSpeakerLabels:2}};const a=process.env.CUSTOM_VOCABULARY_NAME;return a&&\"\"!==a?(console.log(\"Using custom vocabulary: \"+a),{...t,Settings:{...t.Settings,VocabularyName:a}}):t});await Promise.all(r.map(e=>s.startTranscriptionJob(e).promise())),console.log(n);const o=n.map((e,t)=>u.update({TableName:process.env.TABLE_NAME,Key:{jobId:e.meta.jobid,lastModified:e.meta.lastmodified},ExpressionAttributeNames:{\"#status\":\"status\",\"#transcriptionJobName\":\"transcriptionJobName\"},ExpressionAttributeValues:{\":st1\":1,\":tjn\":decodeURIComponent(n[t].key)+\".json\"},UpdateExpression:\"set #status = :st1, #transcriptionJobName = :tjn\",ReturnValues:\"ALL_NEW\"}).promise()),i=await Promise.all(o);console.log({statusCode:200,jobStatus:i.map(e=>e.Attributes)})}}]));","extractedComments":[]}