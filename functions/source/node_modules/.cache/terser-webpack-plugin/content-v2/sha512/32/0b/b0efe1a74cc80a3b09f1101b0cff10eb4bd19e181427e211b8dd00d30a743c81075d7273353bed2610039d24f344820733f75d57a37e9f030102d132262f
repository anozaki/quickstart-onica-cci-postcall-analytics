{"map":"{\"version\":3,\"sources\":[\"analysis/analyseTranscript.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"0\",\"require\",\"21\",\"__webpack_exports__\",\"handler\",\"external_aws_sdk_\",\"template\",\"s3\",\"apiVersion\",\"sns\",\"comprehend\",\"documentClient\",\"DocumentClient\",\"threatRegex\",\"getDominantSentiments\",\"response\",\"merged\",\"concat\",\"arr\",\"ResultList\",\"forEach\",\"item\",\"push\",\"merge\",\"dominantSentiments\",\"turn\",\"getDominantScore\",\"dominantSentiment\",\"Sentiment\",\"SentimentScore\",\"Negative\",\"Positive\",\"doChunk\",\"str\",\"len\",\"input\",\"trim\",\"split\",\"index\",\"output\",\"word\",\"temp\",\"length\",\"chunkDocuments\",\"paragraph\",\"chunk_size\",\"replace\",\"chunks\",\"textList\",\"filter\",\"getDominantClass\",\"status\",\"Classes\",\"reduce\",\"b\",\"Score\",\"getSpeaker\",\"channel\",\"speaker_label\",\"async\",\"event\",\"context\",\"region\",\"process\",\"env\",\"AWS_REGION\",\"accountId\",\"invokedFunctionArn\",\"resolutionEndpointArn\",\"CALL_RESOLUTION_ENDPOINT_ARN\",\"motivationEndpointArn\",\"CALL_MOTIVATION_ENDPOINT_ARN\",\"objectParams\",\"Records\",\"map\",\"bucket\",\"size\",\"extractBucketParams\",\"meta\",\"headObject\",\"Bucket\",\"Key\",\"promise\",\"objectPath\",\"console\",\"log\",\"assetId\",\"slice\",\"s3Response\",\"getObject\",\"JSON\",\"stringify\",\"transcriptText\",\"Body\",\"toString\",\"turns\",\"parse\",\"agentChannel\",\"parseInt\",\"numChannels\",\"AGENT_CHANNEL\",\"AGENT_LABEL\",\"customerChannel\",\"agentTranscript\",\"customerTranscript\",\"json\",\"text\",\"join\",\"getSplit\",\"customerMatches\",\"match\",\"publish\",\"Subject\",\"Message\",\"TopicArn\",\"TOPIC_ARN\",\"agentTranscriptChunks\",\"customerTranscriptChunks\",\"agentParams\",\"TextList\",\"LanguageCode\",\"customerParams\",\"callResolutionEndpointResult\",\"describeEndpoint\",\"EndpointArn\",\"calMotivationEndpointResult\",\"callResolutionEnpointProps\",\"EndpointProperties\",\"callMotivationEndpointProps\",\"agentEntities\",\"customerEntities\",\"agentKeyPhrases\",\"customerKeyPhrases\",\"Promise\",\"all\",\"batchDetectEntities\",\"batchDetectKeyPhrases\",\"callResolutionStatus\",\"callMotivationStatus\",\"Status\",\"crStatus\",\"classifyDocument\",\"Text\",\"Name\",\"cmStatus\",\"agentSentimentBatchResponse\",\"customerSentimentBatchResponse\",\"batchDetectSentiment\",\"agentSentiment\",\"customerSentiment\",\"sentiment\",\"analysisResponse\",\"Entities\",\"KeyPhrases\",\"uploadParams\",\"TEXT_ANALYSIS_OUTPUT_BUCKET\",\"uploadReq\",\"putObject\",\"decodeURIComponent\",\"existingFiles\",\"query\",\"TableName\",\"TABLE_NAME\",\"ExpressionAttributeValues\",\":j\",\"Metadata\",\"jobid\",\":l\",\"lastmodified\",\"KeyConditionExpression\",\"tableUpdates\",\"update\",\"jobId\",\"Items\",\"lastModified\",\"ExpressionAttributeNames\",\"#status\",\"#analysisURI\",\":st\",\":au\",\"UpdateExpression\",\"ReturnValues\",\"error\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var i in e)n.d(s,i,function(t){return e[t]}.bind(null,i));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=21)}({0:function(e,t){e.exports=require(\"aws-sdk\")},21:function(e,t,n){\"use strict\";n.r(t),n.d(t,\"handler\",(function(){return h}));var s=n(0),i='{\"asset_id\":<AssetId>,\"turns\":<Turns>,\"customer_entities\":<CustomerEntities>,\"customer_keyphrases\":<CustomerKeyPhrases>,\"agent_entities\":<AgentEntities>,\"agent_keyphrases\":<AgentKeyPhrases>,\"call_resolution_status\":<CallResolutionStatus>,\"call_motivation_status\":<CallMotivationStatus>}';const o=new s.S3({apiVersion:\"2006-03-01\"}),r=new s.SNS,a=new s.Comprehend,c=new s.DynamoDB.DocumentClient,l=/(kill)\\s(your)(self|selves)|(kill)\\s(them|him|her)|(commit)\\s(suicide)|(I)\\s(hope)\\s(you|she|he|they)\\s*(die)s?/gi,u=e=>{let t=[].concat(...(e=>{let t=[{ResultList:[]}];return e.forEach(e=>{t.ResultList=t[0].ResultList.push(...e.ResultList)}),t})(e)),n=[];return t[0].ResultList.forEach(e=>{n.push(p(e))}),n},p=e=>{let t={Sentiment:\"\",SentimentScore:0};return t=e.SentimentScore.Negative>.4&&e.SentimentScore.Positive>.6?e.SentimentScore.Negative>e.SentimentScore.Positive?{Sentiment:\"NEGATIVE\",SentimentScore:e.SentimentScore.Negative}:{Sentiment:\"POSITIVE\",SentimentScore:e.SentimentScore.Positive}:e.SentimentScore.Negative>.4?{Sentiment:\"NEGATIVE\",SentimentScore:e.SentimentScore.Negative}:e.SentimentScore.Positive>.6?{Sentiment:\"POSITIVE\",SentimentScore:e.SentimentScore.Positive}:e.SentimentScore.Negative>e.SentimentScore.Positive?{Sentiment:\"NEGATIVE\",SentimentScore:e.SentimentScore.Negative}:{Sentiment:\"POSITIVE\",SentimentScore:e.SentimentScore.Positive},t},m=(e,t)=>{let n=e.trim().split(\" \"),[s,i]=[0,[]];return i[s]=\"\",n.forEach(e=>{let n=`${i[s]} ${e}`.trim();n.length<=t?i[s]=n:(s++,i[s]=e)}),i},S=(e,t=5e3)=>(e=e.replace(\"|\",\"\"),m(e,t)),g=(e,t=5e3)=>{const n=[];return e.split(\"|\").filter(e=>e.trim()).forEach(e=>{n.push(m(e,t))}),n},f=e=>e.Classes.reduce((e,t)=>e.Score>t.Score?e:t),d=e=>e.hasOwnProperty(\"channel\")?e.channel:e.speaker_label,h=async(e,t)=>{const n=process.env.AWS_REGION,s=t.invokedFunctionArn.split(\":\")[4],p=process.env.CALL_RESOLUTION_ENDPOINT_ARN.replace(\"region\",n).replace(\"account-id\",s),m=process.env.CALL_MOTIVATION_ENDPOINT_ARN.replace(\"region\",n).replace(\"account-id\",s);try{const t=(e=>e.Records.map(({s3:e})=>({name:e.bucket.name,key:e.object.key,size:e.object.size})))(e),n=await o.headObject({Bucket:t[0].name,Key:t[0].key}).promise(),s=`s3://${t[0].name}/${t[0].key}`;console.log(\"1: object path\"+s);const h=t[0].key.split(\"/\").slice(-1)[0].split(\".\")[0],y=await o.getObject({Bucket:t[0].name,Key:t[0].key}).promise();console.log(\"2: s3 response from get\"+JSON.stringify(y));const E=y.Body.toString(\"utf-8\"),N=JSON.parse(E),b=parseInt(2===N.numChannels?process.env.AGENT_CHANNEL:process.env.AGENT_LABEL),v=0===b?1:0,[A,T]=((e,t)=>{const n=e.turns,s=0===t?1:0;return[n.filter(e=>d(e)===t).map(e=>e.text).join(\"|\"),n.filter(e=>d(e)===s).map(e=>e.text).join(\"|\")]})(N,b);console.log(\"3: checking for threatening language...\");const I=(T||\"\").split(\"|\").filter(e=>e.match(l));I.length>0&&await r.publish({Subject:\"Threatening caller\",Message:\"A caller has been flagged for threatening language: \"+I.join(\". \"),TopicArn:process.env.TOPIC_ARN}).promise();let _=g(A),O=g(T);const P={TextList:[].concat(...S(A.replace(\"|\",\"\"))),LanguageCode:\"en\"},L={TextList:[].concat(...S(T.replace(\"|\",\"\"))),LanguageCode:\"en\"},j=await a.describeEndpoint({EndpointArn:p}).promise(),R=await a.describeEndpoint({EndpointArn:m}).promise(),C=j.EndpointProperties,k=R.EndpointProperties;console.log(\"4: entities and key phrases...\");const[w,x,D,M]=await Promise.all([a.batchDetectEntities(P).promise(),a.batchDetectEntities(L).promise(),a.batchDetectKeyPhrases(P).promise(),a.batchDetectKeyPhrases(L).promise()]);let K=\"UNDETERMINED\",V=\"UNDETERMINED\";if(console.log(\"5: classifying...\"),\"IN_SERVICE\"===C.Status){console.log(\"classifying document by call resolution classifer...\");const e=await a.classifyDocument({EndpointArn:p,Text:O.slice(-3).join(\" \")}).promise();K=f(e).Name}if(\"IN_SERVICE\"===k.Status){console.log(\"classifying document by call motivation classifer...\");const e=await a.classifyDocument({EndpointArn:m,Text:O.slice(0,3).join(\" \")}).promise();V=f(e).Name}let B=[],U=[];for(;0!==_.length;){const e=[].concat(..._).slice(0,25);0!==e.length&&(B.push(await a.batchDetectSentiment({TextList:e,LanguageCode:\"en\"}).promise()),_=_.slice(25))}for(;0!==O.length;){const e=[].concat(...O).slice(0,25);0!==e.length&&(U.push(await a.batchDetectSentiment({TextList:e,LanguageCode:\"en\"}).promise()),O=O.slice(25))}const J=u(B),G=u(U);N.turns.filter(e=>e.channel==v||e.speaker_label==v).map((e,t)=>e.sentiment=G[t]),N.turns.filter(e=>e.channel==b||e.speaker_label==b).map((e,t)=>e.sentiment=J[t]);const $=i.replace(\"<AssetId>\",JSON.stringify(h)).replace(\"<Turns>\",JSON.stringify(N.turns)).replace(\"<CustomerEntities>\",JSON.stringify(x.ResultList.filter(e=>0!=e.Entities.length),null)).replace(\"<CustomerKeyPhrases>\",JSON.stringify(M.ResultList.filter(e=>0!=e.KeyPhrases.length),null)).replace(\"<AgentEntities>\",JSON.stringify(w.ResultList.filter(e=>0!=e.Entities.length),null)).replace(\"<AgentKeyPhrases>\",JSON.stringify(D.ResultList.filter(e=>0!=e.KeyPhrases.length),null)).replace(\"<CallResolutionStatus>\",JSON.stringify(K)).replace(\"<CallMotivationStatus>\",JSON.stringify(V)),q={Bucket:process.env.TEXT_ANALYSIS_OUTPUT_BUCKET,Key:h+\".json\",Body:$},z=await o.putObject(q).promise();console.log(\"Searching for \"+decodeURIComponent(s));const F=await c.query({TableName:process.env.TABLE_NAME,ExpressionAttributeValues:{\":j\":n.Metadata.jobid,\":l\":n.Metadata.lastmodified},KeyConditionExpression:\"jobId = :j and lastModified = :l\"}).promise();console.log(F);const W=await c.update({TableName:process.env.TABLE_NAME,Key:{jobId:F.Items[0].jobId,lastModified:F.Items[0].lastModified},ExpressionAttributeNames:{\"#status\":\"status\",\"#analysisURI\":\"analysisURI\"},ExpressionAttributeValues:{\":st\":3,\":au\":`s3://${q.Bucket}/${q.Key}`},UpdateExpression:\"set #status = :st, #analysisURI = :au\",ReturnValues:\"ALL_NEW\"}).promise();return console.log(W),z}catch(e){throw console.error(\"Failed:\",e),e}}}}));","extractedComments":[]}