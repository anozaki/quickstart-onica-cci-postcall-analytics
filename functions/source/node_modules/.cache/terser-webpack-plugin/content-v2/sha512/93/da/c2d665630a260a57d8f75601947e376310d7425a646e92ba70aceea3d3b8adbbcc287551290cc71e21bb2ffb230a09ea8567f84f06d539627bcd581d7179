{"map":"{\"version\":3,\"sources\":[\"analysis/splitTranscript.js\"],\"names\":[\"e\",\"a\",\"i\",\"exports\",\"modules\",\"installedModules\",\"__webpack_require__\",\"moduleId\",\"module\",\"l\",\"call\",\"m\",\"c\",\"d\",\"name\",\"getter\",\"o\",\"Object\",\"defineProperty\",\"enumerable\",\"get\",\"r\",\"Symbol\",\"toStringTag\",\"value\",\"t\",\"mode\",\"__esModule\",\"ns\",\"create\",\"key\",\"bind\",\"n\",\"object\",\"property\",\"prototype\",\"hasOwnProperty\",\"p\",\"s\",\"0\",\"require\",\"9\",\"__webpack_exports__\",\"extractBucketParams\",\"getTurns\",\"handler\",\"aws_sdk__WEBPACK_IMPORTED_MODULE_0__\",\"s3\",\"apiVersion\",\"documentClient\",\"DocumentClient\",\"event\",\"Records\",\"map\",\"bucket\",\"size\",\"json\",\"channelZero\",\"channelOne\",\"results\",\"channel_labels\",\"channels\",\"items\",\"item\",\"channel\",\"segments\",\"speaker_labels\",\"reduce\",\"all\",\"segment\",\"concat\",\"find\",\"start_time\",\"end_time\",\"filter\",\"speaker_label\",\"concatted\",\"labeledByTurn\",\"combined\",\"word\",\"sort\",\"b\",\"parseFloat\",\"labeled\",\"last\",\"length\",\"turn\",\"turns\",\"[object Object]\",\"flattenedTurns\",\"keys\",\"text\",\"alternatives\",\"content\",\"join\",\"replace\",\"numChannels\",\"async\",\"objectParams\",\"objectKey\",\"console\",\"log\",\"transcriptText\",\"getObject\",\"Bucket\",\"Key\",\"promise\",\"Body\",\"toString\",\"transcriptJson\",\"JSON\",\"parse\",\"speakerJson\",\"existingFiles\",\"query\",\"ExpressionAttributeValues\",\":t\",\"decodeURIComponent\",\"KeyConditionExpression\",\"TableName\",\"process\",\"env\",\"TABLE_NAME\",\"IndexName\",\"uploadParams\",\"SPLIT_TRANSCRIPT_OUTPUT_BUCKET\",\"stringify\",\"Metadata\",\"jobId\",\"Items\",\"lastModified\",\"uploadReq\",\"putObject\",\"tableUpdates\",\"update\",\"ExpressionAttributeNames\",\"#status\",\"#transcriptURI\",\"#fullTranscriptURI\",\":st\",\":tu\",\":ftu\",\"UpdateExpression\",\"ReturnValues\",\"error\"],\"mappings\":\"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\"}","code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=9)}({0:function(e,t){e.exports=require(\"aws-sdk\")},9:function(e,t,n){\"use strict\";n.r(t),n.d(t,\"extractBucketParams\",(function(){return o})),n.d(t,\"getTurns\",(function(){return l})),n.d(t,\"handler\",(function(){return c}));var r=n(0);const a=new r.S3({apiVersion:\"2006-03-01\"}),s=new r.DynamoDB.DocumentClient,o=e=>e.Records.map(({s3:e})=>({name:e.bucket.name,key:e.object.key,size:e.object.size})),l=e=>{let t,n;if(e.results.channel_labels)t=e.results.channel_labels.channels[0].items.map(e=>({...e,channel:0})),n=e.results.channel_labels.channels[1].items.map(e=>({...e,channel:1}));else{const r=e.results.items,a=e.results.speaker_labels.segments.reduce((e,t)=>e.concat(t.items),[]).map(e=>({...e,...r.find(t=>t.start_time===e.start_time&&t.end_time===e.end_time)||{}}));t=a.filter(e=>\"spk_0\"===e.speaker_label).map(e=>({...e,speaker_label:0})),n=a.filter(e=>\"spk_1\"===e.speaker_label).map(e=>({...e,speaker_label:1}))}const r=t.concat(n);let a,s=r.map((e,t)=>e.start_time?e:{...e,start_time:r[t-1].start_time});s.sort((e,t)=>parseFloat(e.start_time)-parseFloat(t.start_time)),a=s[0].hasOwnProperty(\"speaker_label\")?s.reduce((e,t)=>{const n=e[e.length-1];return 0===e.length?e.concat({...t,turn:0}):n.speaker_label!==t.speaker_label?e.concat({...t,turn:n.turn+1}):e.concat({...t,turn:n.turn})},[]):s.reduce((e,t)=>{const n=e[e.length-1];return 0===e.length?e.concat({...t,turn:0}):n.channel!==t.channel?e.concat({...t,turn:n.turn+1}):e.concat({...t,turn:n.turn})},[]);const o=a.reduce((e,t)=>({...e,[t.turn]:e[t.turn]?e[t.turn].concat(t):[t]}),{});let l;return l=s[0].hasOwnProperty(\"speaker_label\")?Object.keys(o).map(e=>({turn:e,text:o[e].map(e=>e.alternatives[0].content).join(\" \").replace(/\\s+(\\W)/g,\"$1\"),start_time:o[e][0].start_time,speaker_label:o[e][0].speaker_label})):Object.keys(o).map(e=>({turn:e,text:o[e].map(e=>e.alternatives[0].content).join(\" \").replace(/\\s+(\\W)/g,\"$1\"),start_time:o[e][0].start_time,channel:o[e][0].channel})),{numChannels:e.results.channel_labels?2:1,turns:l}},c=async e=>{try{const t=o(e),n=\"\"+t[0].key;console.log(n);const r=(await a.getObject({Bucket:t[0].name,Key:t[0].key}).promise()).Body.toString(\"utf-8\"),c=JSON.parse(r),u=l(c),i=await s.query({ExpressionAttributeValues:{\":t\":decodeURIComponent(n)},KeyConditionExpression:\"transcriptionJobName = :t\",TableName:process.env.TABLE_NAME,IndexName:\"jobStatusGSI\"}).promise();console.log(i);const p={Bucket:process.env.SPLIT_TRANSCRIPT_OUTPUT_BUCKET,Key:t[0].key,Body:JSON.stringify(u),Metadata:{jobId:i.Items[0].jobId,lastModified:i.Items[0].lastModified}},m=await a.putObject(p).promise();console.log(\"Searching for \"+decodeURIComponent(n));const d=await s.update({TableName:process.env.TABLE_NAME,Key:{jobId:i.Items[0].jobId,lastModified:i.Items[0].lastModified},ExpressionAttributeNames:{\"#status\":\"status\",\"#transcriptURI\":\"transcriptURI\",\"#fullTranscriptURI\":\"fullTranscriptURI\"},ExpressionAttributeValues:{\":st\":2,\":tu\":`s3://${p.Bucket}/${p.Key}`,\":ftu\":`s3://${t[0].name}/${t[0].key}`},UpdateExpression:\"set #status = :st, #fullTranscriptURI = :ftu, #transcriptURI = :tu\",ReturnValues:\"ALL_NEW\"}).promise();return console.log(d),m}catch(e){throw console.error(\"Failed:\",e),e}}}}));","extractedComments":[]}