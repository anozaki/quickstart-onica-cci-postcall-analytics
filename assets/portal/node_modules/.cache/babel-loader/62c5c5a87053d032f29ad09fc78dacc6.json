{"ast":null,"code":"import _slicedToArray from\"/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _defineProperty from\"/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import*as React from\"react\";import{CardContent,Typography,CardActions,Button,Paper,Card,makeStyles,Container,Grid,Chip,Avatar,CircularProgress}from\"@material-ui/core\";import CloudUploadIcon from'@material-ui/icons/CloudUpload';import SaveIcon from'@material-ui/icons/Save';import Dropzone from'react-dropzone';import{v4}from'uuid';import{ApiService}from\"../service/api.service\";import NavigationBar from\"../navigation/NavigationBar\";import moment from'moment';import{connect}from'react-redux';import{withStyles}from\"@material-ui/core\";import requiresAuth from\"../common/requiresAuth\";var apiService=new ApiService();var styles=function styles(){return{};};var useStyles=makeStyles({root:{minWidth:275},bullet:{display:'inline-block',margin:'0 2px',transform:'scale(0.8)'},title:{fontSize:14},pos:{marginBottom:12},paper:{padding:2,textAlign:'center'}});export var readFile=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(file){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",new Promise(function(res,rej){var reader=new FileReader();reader.onabort=function(){return rej('File read aborted');};reader.onerror=function(e){return rej(e);};reader.onloadend=function(){return res({data:reader.result,contentType:file.type,name:file.name.replace(/ /g,\"_\"),lastModified:moment.utc(new Date(file.lastModified)).toISOString()});};reader.readAsArrayBuffer(file);}));case 1:case\"end\":return _context.stop();}}},_callee);}));return function readFile(_x){return _ref.apply(this,arguments);};}();var Upload=function Upload(props){var _cases;var FILE_DROPPED='FILE_DROPPED';var FILE_REMOVED='FILE_REMOVED';var CLEAR_FILES='CLEAR_FILES';var PENDING='PENDING';var SUCCESS='SUCCESS';var FAIL='FAIL';var initialState={status:null,files:[]};var classes=useStyles();var cases=(_cases={},_defineProperty(_cases,FILE_DROPPED,function(state,payload){return{status:null,files:state.files.concat(payload)};}),_defineProperty(_cases,FILE_REMOVED,function(state,payload){return{status:null,files:state.files.filter(function(f){return f.path!==payload;})};}),_defineProperty(_cases,CLEAR_FILES,function(){return initialState;}),_defineProperty(_cases,PENDING,function(state){return _objectSpread(_objectSpread({},state),{},{status:PENDING});}),_defineProperty(_cases,SUCCESS,function(){return _objectSpread(_objectSpread({},initialState),{},{status:SUCCESS});}),_defineProperty(_cases,FAIL,function(state){return _objectSpread(_objectSpread({},state),{},{status:FAIL});}),_cases);var reducer=function reducer(state,action){return cases[action.type]?cases[action.type](state,action.payload):state;};var _React$useReducer=React.useReducer(reducer,initialState),_React$useReducer2=_slicedToArray(_React$useReducer,2),state=_React$useReducer2[0],dispatch=_React$useReducer2[1];var filesDropped=function filesDropped(accepted,rejected,event){return dispatch({type:FILE_DROPPED,payload:accepted});};var removeFile=function removeFile(path){return dispatch({type:FILE_REMOVED,payload:path});};var clearFiles=function clearFiles(){return dispatch({type:CLEAR_FILES});};console.log(\"Stage: \".concat(process.env.STAGE));var getToken=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var token;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return apiService.getAuth();case 2:token=_context2.sent;if(token){_context2.next=5;break;}throw Error('No token found');case 5:return _context2.abrupt(\"return\",token);case 6:case\"end\":return _context2.stop();}}},_callee2);}));return function getToken(){return _ref2.apply(this,arguments);};}();var authenticatedUpload=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var files,token,response,body,s3Response;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return Promise.all(state.files.map(function(file){return readFile(file);}));case 2:files=_context3.sent;if(files){_context3.next=5;break;}throw Error('No files to upload');case 5:_context3.next=7;return getToken();case 7:token=_context3.sent;_context3.next=10;return fetch(\"\".concat(process.env.REACT_APP_BASE_API,\"/api/presigned\"),{method:'POST',headers:{Authorization:\"\".concat(token.accessToken)},redirect:'follow',// manual, *follow, error\nreferrerPolicy:'no-referrer',// no-referrer, *client\nbody:JSON.stringify({files:files.map(function(file){return{name:file.name.replace(/ /g,\"_\"),type:file.contentType,lastModified:file.lastModified,jobId:v4()};})})});case 10:response=_context3.sent;if(response.ok){_context3.next=13;break;}throw Error(response.statusText);case 13:_context3.next=15;return response.json();case 15:body=_context3.sent;console.log(body);_context3.next=19;return getToken();case 19:token=_context3.sent;_context3.next=22;return fetch(\"\".concat(process.env.REACT_APP_BASE_API,\"/api/status\"),{method:'POST',headers:{Authorization:\"\".concat(token.accessToken)},redirect:'follow',// manual, *follow, error\nreferrerPolicy:'no-referrer',// no-referrer, *client\nbody:JSON.stringify({uris:body.map(function(s){return{uri:\"s3://\".concat(s.Bucket,\"/\").concat(s.Key),lastModified:s.lastModified,jobId:s.jobId};})})});case 22:_context3.next=24;return Promise.all(body.map(function(response){var file=files.find(function(file){return file.name.replace(/ /g,\"_\")===response.name;});if(!file)throw Error('No file found for name '+response.name);return fetch(response.url,{method:'PUT',headers:{'Content-Type':file.contentType},redirect:'follow',// manual, *follow, error\nreferrerPolicy:'no-referrer',// no-referrer, *client\nbody:file.data});}));case 24:s3Response=_context3.sent;console.log(s3Response);case 26:case\"end\":return _context3.stop();}}},_callee3);}));return function authenticatedUpload(){return _ref3.apply(this,arguments);};}();var upload=function upload(){dispatch({type:PENDING});authenticatedUpload().then(function(){dispatch({type:SUCCESS});}).catch(function(e){console.log(e);dispatch({type:FAIL});});};return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(NavigationBar,props),/*#__PURE__*/React.createElement(Paper,null,/*#__PURE__*/React.createElement(Card,{className:classes.root},/*#__PURE__*/React.createElement(CardContent,null,/*#__PURE__*/React.createElement(Typography,{color:\"textSecondary\",gutterBottom:true,className:classes.title},\"Upload Files\"),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:3},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12},/*#__PURE__*/React.createElement(Paper,{variant:\"outlined\",className:classes.paper},/*#__PURE__*/React.createElement(Dropzone,{onDrop:filesDropped},function(_ref4){var getRootProps=_ref4.getRootProps,getInputProps=_ref4.getInputProps;return/*#__PURE__*/React.createElement(\"div\",Object.assign({style:{height:'30vh'}},getRootProps()),/*#__PURE__*/React.createElement(\"input\",getInputProps()),/*#__PURE__*/React.createElement(Typography,{className:classes.title},\"Drag and drop files here\"));})))),/*#__PURE__*/React.createElement(Container,null,state.files.map(function(f){return/*#__PURE__*/React.createElement(Chip,{key:f.path,avatar:/*#__PURE__*/React.createElement(Avatar,{alt:\"File\"},/*#__PURE__*/React.createElement(SaveIcon,null)),label:f.path,onDelete:function onDelete(){return removeFile(f.path);}});}))),/*#__PURE__*/React.createElement(CardActions,null,/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"default\",size:\"small\",onClick:clearFiles},\"Clear\"),/*#__PURE__*/React.createElement(Button,{disabled:state.status===PENDING,variant:\"contained\",color:\"primary\",startIcon:/*#__PURE__*/React.createElement(CloudUploadIcon,null),onClick:upload},\"Upload\"),state.status===FAIL&&/*#__PURE__*/React.createElement(Typography,{color:\"textSecondary\"},\"Upload Failed. Try Logging In.\"),state.status===PENDING&&/*#__PURE__*/React.createElement(CircularProgress,null),state.status===SUCCESS&&/*#__PURE__*/React.createElement(Typography,{color:\"textSecondary\"},\"Upload Successful\")))));};var mapStateToProps=function mapStateToProps(){return{};};var mapDispatchToProps=function mapDispatchToProps(){return{};};export default connect(mapStateToProps,mapDispatchToProps)(withStyles(styles)(requiresAuth(Upload)));","map":{"version":3,"sources":["/Users/sshvans/Documents/work/quickstart/quickstart-onica-cci-postcall-analytics/assets/portal/src/upload/Upload.tsx"],"names":["React","CardContent","Typography","CardActions","Button","Paper","Card","makeStyles","Container","Grid","Chip","Avatar","CircularProgress","CloudUploadIcon","SaveIcon","Dropzone","v4","ApiService","NavigationBar","moment","connect","withStyles","requiresAuth","apiService","styles","useStyles","root","minWidth","bullet","display","margin","transform","title","fontSize","pos","marginBottom","paper","padding","textAlign","readFile","file","Promise","res","rej","reader","FileReader","onabort","onerror","e","onloadend","data","result","contentType","type","name","replace","lastModified","utc","Date","toISOString","readAsArrayBuffer","Upload","props","FILE_DROPPED","FILE_REMOVED","CLEAR_FILES","PENDING","SUCCESS","FAIL","initialState","status","files","classes","cases","state","payload","concat","filter","f","path","reducer","action","useReducer","dispatch","filesDropped","accepted","rejected","event","removeFile","clearFiles","console","log","process","env","STAGE","getToken","getAuth","token","Error","authenticatedUpload","all","map","fetch","REACT_APP_BASE_API","method","headers","Authorization","accessToken","redirect","referrerPolicy","body","JSON","stringify","jobId","response","ok","statusText","json","uris","s","uri","Bucket","Key","find","url","s3Response","upload","then","catch","getRootProps","getInputProps","height","mapStateToProps","mapDispatchToProps"],"mappings":"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","sourcesContent":["import * as React from \"react\"\nimport { CardContent, Typography, CardActions, Button, Paper, Card, makeStyles, Container, Grid, Chip, Avatar, CircularProgress } from \"@material-ui/core\"\nimport CloudUploadIcon from '@material-ui/icons/CloudUpload'\nimport SaveIcon from '@material-ui/icons/Save'\nimport Dropzone, { DropEvent } from 'react-dropzone'\nimport { v4 } from 'uuid'\nimport {ApiService} from \"../service/api.service\"\nimport AuthDto from \"../dto/auth.dto\"\nimport NavigationBar from \"../navigation/NavigationBar\"\nimport moment from 'moment'\nimport {connect} from 'react-redux'\nimport {withStyles} from \"@material-ui/core\"\nimport requiresAuth from \"../common/requiresAuth\"\n\nconst apiService = new ApiService()\n\nconst styles = () => ({\n})\n\nconst useStyles = makeStyles({\n  root: {\n    minWidth: 275,\n  },\n  bullet: {\n    display: 'inline-block',\n    margin: '0 2px',\n    transform: 'scale(0.8)',\n  },\n  title: {\n    fontSize: 14,\n  },\n  pos: {\n    marginBottom: 12,\n  },\n  paper: {\n    padding: 2,\n    textAlign: 'center',\n  }\n})\n\ninterface FileWithPath extends File {\n  path: string;\n}\n\ntype Upload = {\n  history: any;\n  token: any;\n  refreshToken: () => Promise<any>;\n  updateToken: (token: any) => void;\n}\n\ntype FileData = {\n  data: string | ArrayBuffer | null;\n  contentType: string;\n  name: string;\n  lastModified: string;\n}\n\ntype UploadState = {\n  status: string | null;\n  files: FileWithPath[];\n}\n\ntype UploadAction = {\n  type: string;\n  payload?: any;\n}\n\ntype UploadCases = {\n  [a: string]: (b: UploadState, c: any) => UploadState\n}\n\nexport const readFile = async (file: File): Promise<FileData> => new Promise((res, rej) => {\n  const reader = new FileReader()\n  reader.onabort = () => rej('File read aborted')\n  reader.onerror = (e) => rej(e)\n  reader.onloadend = () => res({\n    data: reader.result,\n    contentType: file.type,\n    name: file.name.replace(/ /g,\"_\"),\n    lastModified: moment.utc(new Date(file.lastModified)).toISOString()\n  })\n  reader.readAsArrayBuffer(file)\n})\n\nconst Upload = (props: Upload) => {\n  const FILE_DROPPED = 'FILE_DROPPED'\n  const FILE_REMOVED = 'FILE_REMOVED'\n  const CLEAR_FILES = 'CLEAR_FILES'\n  const PENDING = 'PENDING'\n  const SUCCESS = 'SUCCESS'\n  const FAIL = 'FAIL'\n\n  const initialState: UploadState = {\n    status: null,\n    files: []\n  }\n  const classes = useStyles()\n\n  const cases: UploadCases = {\n    [FILE_DROPPED]: (state: UploadState, payload): UploadState => ({\n      status: null,\n      files: state.files.concat(payload)\n    }),\n    [FILE_REMOVED]: (state: UploadState, payload): UploadState => ({\n      status: null,\n      files: state.files.filter(f => f.path !== payload)\n    }),\n    [CLEAR_FILES]: (): UploadState => initialState,\n    [PENDING]: (state: UploadState) => ({\n      ...state,\n      status: PENDING,\n    }),\n    [SUCCESS]: (): UploadState => ({\n      ...initialState,\n      status: SUCCESS\n    }),\n    [FAIL]: (state: UploadState): UploadState => ({\n      ...state,\n      status: FAIL\n    })\n  }\n\n  const reducer = (state: UploadState, action: UploadAction): UploadState => cases[action.type] ? cases[action.type](state, action.payload) : state\n  const [state, dispatch] = React.useReducer(reducer, initialState)\n  const filesDropped = (accepted: File[], rejected: File[], event: DropEvent) => dispatch({\n    type: FILE_DROPPED,\n    payload: accepted\n  })\n  const removeFile = (path: string) => dispatch({ type: FILE_REMOVED, payload: path })\n  const clearFiles = () => dispatch({ type: CLEAR_FILES })\n  console.log(`Stage: ${process.env.STAGE}`)\n\n  const getToken = async (): Promise<AuthDto> => {\n    const token = await apiService.getAuth()\n    if (!token) throw Error('No token found')\n    return token\n  }\n\n  const authenticatedUpload = async () => {\n    const files: FileData[] = await Promise.all(state.files.map((file: File) => readFile(file)))\n    if (!files) throw Error('No files to upload')\n    let token = await getToken()\n    const response = await fetch(`${process.env.REACT_APP_BASE_API}/api/presigned`, {\n      method: 'POST',\n      headers: {\n        Authorization: `${token.accessToken}`\n      },\n      redirect: 'follow', // manual, *follow, error\n      referrerPolicy: 'no-referrer', // no-referrer, *client\n      body: JSON.stringify({\n        files: files.map(file => ({ name: file.name.replace(/ /g,\"_\"), type: file.contentType , lastModified: file.lastModified, jobId: v4() }))\n      })\n    })\n    if (!response.ok) throw Error(response.statusText)\n\n    const body = await response.json()\n    console.log(body)\n\n    token = await getToken()\n    // update status in dynamodb\n    await fetch(`${process.env.REACT_APP_BASE_API}/api/status`, {\n      method: 'POST',\n      headers: {\n        Authorization: `${token.accessToken}`\n      },\n      redirect: 'follow', // manual, *follow, error\n      referrerPolicy: 'no-referrer', // no-referrer, *client\n      body: JSON.stringify({\n        uris: body.map((s: any) => ({\n          uri: `s3://${s.Bucket}/${s.Key}`,\n          lastModified: s.lastModified,\n          jobId: s.jobId\n        }))\n      })\n    })\n\n    // use array of presigned urls to upload\n    const s3Response: Response[] = await Promise.all(body.map((response: any) => {\n      const file = files.find(file => file.name.replace(/ /g,\"_\") === response.name)\n      if (!file) throw Error('No file found for name ' + response.name)\n      return fetch(response.url, {\n        method: 'PUT',\n        headers: {\n          'Content-Type': file.contentType\n        },\n        redirect: 'follow', // manual, *follow, error\n        referrerPolicy: 'no-referrer', // no-referrer, *client\n        body: file.data\n      })\n    }))\n    console.log(s3Response)\n\n  }\n\n  const upload = () => {\n    dispatch({ type: PENDING })\n\n    authenticatedUpload()\n    .then(() => {\n      dispatch({ type: SUCCESS })\n    })\n    .catch(e => {\n      console.log(e)\n      dispatch({ type: FAIL })\n    })\n  }\n\n  return (\n    <div>\n      <NavigationBar { ...props } />\n      <Paper>\n        <Card className={classes.root}>\n          <CardContent>\n            <Typography color=\"textSecondary\" gutterBottom className={classes.title}>\n              Upload Files\n            </Typography>\n            <Grid\n              container\n              spacing={3}>\n              <Grid item xs={12}>\n                  <Paper variant=\"outlined\" className={classes.paper}>\n                    <Dropzone onDrop={filesDropped}>\n                      {({getRootProps, getInputProps}) =>\n                        <div style={{height: '30vh'}} {...getRootProps()}>\n                          <input {...getInputProps()} />\n                          <Typography className={classes.title} >\n                            Drag and drop files here\n                          </Typography>\n                        </div>}\n                    </Dropzone>\n                  </Paper>\n              </Grid>\n            </Grid>\n            <Container>\n              {state.files.map(f => <Chip\n                key={f.path}\n                avatar={<Avatar alt=\"File\"><SaveIcon /></Avatar>}\n                label={f.path}\n                onDelete={() => removeFile(f.path)}\n              />)}\n            </Container>\n          </CardContent>\n          <CardActions>\n            <Button\n              variant=\"contained\"\n              color=\"default\"\n              size=\"small\"\n              onClick={clearFiles}>\n                Clear\n            </Button>\n            <Button\n              disabled={state.status === PENDING}\n              variant=\"contained\"\n              color=\"primary\"\n              startIcon={<CloudUploadIcon/>}\n              onClick={upload}>\n              Upload\n            </Button>\n            {state.status === FAIL && <Typography color=\"textSecondary\">Upload Failed. Try Logging In.</Typography>}\n            {state.status === PENDING && <CircularProgress />}\n            {state.status === SUCCESS && <Typography color=\"textSecondary\">Upload Successful</Typography>}\n          </CardActions>\n        </Card>\n      </Paper>\n    </div>)\n}\n\nconst mapStateToProps = () => {\n  return {}\n}\n\nconst mapDispatchToProps = () => {\n  return {}\n}\n\nexport default connect(mapStateToProps, mapDispatchToProps)(withStyles(styles)(requiresAuth(Upload)))\n"]},"metadata":{},"sourceType":"module"}